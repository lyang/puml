language: java
jdk:
  - openjdk11
services:
  - docker
env:
  - BAZEL_VERSION=1.2.1
jobs:
  include:
    - stage: build
      script:
        - |
          URL="https://github.com/bazelbuild/bazel/releases/download/${BAZEL_VERSION}/bazel-${BAZEL_VERSION}-installer-linux-x86_64.sh"
          wget -qO install.sh "${URL}"
          chmod +x install.sh
          ./install.sh --user > /dev/null
          rm -f install.sh
        - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
        - bazel run //:docker
        - bazel run //:docker-push
        - docker tag puml:docker $DOCKER_USERNAME/puml:latest
        - docker push $DOCKER_USERNAME/puml:latest
    - if: branch = master
      stage: deploy
      script:
        - curl https://cli-assets.heroku.com/install-ubuntu.sh | sh > /dev/null
        - heroku container:login
        - docker build -t registry.heroku.com/$APP/web -f Dockerfile.heroku .
        - docker push registry.heroku.com/$APP/web
        - heroku container:release web --app $APP
